import React from 'react'
import Layout from  '../layout'
import Footer from  '../footer'
import TopNav from '../topnav'
import LeftNav from '../leftnav'
import Table from '../table'
import Content from '../content'
import Filters from '../filters'

import {fromJS, List} from 'immutable'

// TODO: Get view listening to the store correctly. (Generic solution?)
import Store from '../../store'

// TODO: Combine all the disparate logic into a single 'feature'
import {getAgingReports} from '../../actions/aging'
import {getActive, getInactive, getAll} from '../../queries/aging'

// Filter components

import {
  RadioButton,
  RadioButtonGroup,
  Checkbox,
  FlatButton,
  RaisedButton,
  FloatingActionButton,
  IconButton,
  Toggle,
  Slider,
  DropDownMenu,
  DatePicker,
  TextField
} from 'material-ui'

// Table Data
let colNames = [
  'Customer',
  'Status',
  'Balance',
  '0 - 30',
  '31 - 60',
  '61 - 90',
  '91+',
  'Send Late Notice',
  'Last Weekly Notice',
  'Last Monthly Notice',
  'Agent',
  'State'
];

let rows = 'a b c d e f g h i j k l m n o p q r s t u v w x y z'
  .split(' ')
  .map(c => colNames.map(n => `${c} - ${n}`));

export default class Aging extends React.Component {
  constructor() {
    super();
    this.state = {
      colNames: colNames,
      rows: fromJS(rows),
      showZeros: false,
      filter: 'active'
    };
    this.getStateFromStore = this.getStateFromStore.bind(this);
  }
  updateState() {
    this.setState({rows: this.getState()});
  }
  getState() {
    return this.getStateFromStore(this.state.filter, this.state.showZeros);
  }
  getStateFromStore(filter, showZeros) {
    let data;
    if (filter === 'active') {
      data = getActive(!showZeros);
    } else if (filter === 'inactive') {
      data = getInactive(!showZeros);
    } else {
      data = getAll(!showZeros);
    }
    return data;
  }
  componentWillMount() {
    getAgingReports();
  }
  componentDidMount() {
    this.updateState();
    Store.on('update', () => this.updateState());
  }
  componentWillDismount() {
    // TODO: Add a Store.off method
    //Store.off('update', this.getStateFromStore);
  }
  computeRows() {
    return this.state.rows.toList().toJS()
      .map(r => this.rowToArray(r));
  }
  rowToArray(r) {
    return [
      r.name,
      r.active,
      r.balance, r.b_0_30, r.b_31_60, r.b_61_90, r.b_91,
      r.button_disabled ? "" : "Send Late Notice",
      r.weekly_late_notice_sent,
      r.late_notice_sent,
      r.agent
    ];
  }
  handleFilterChange(e, value) {
    this.setState({
      filter: value,
      rows: this.getStateFromStore(value, this.state.checked)
    });
  }
  handleshowZerosChange(e, value) {
    this.setState({
      showZeros: value,
      rows: this.getStateFromStore(this.state.filter, value)
    });
  }
  render() {
    let rowsData = this.computeRows();
    return (
      <div>
        <TopNav />
        <div className="main">
          <Layout>
            <LeftNav />
            <Content>
              <Layout widths={{lg: [12], md: [12], sm: [12], xs: [12]}}>
                <div>
                  <div className="section-header">
                    <h1>Aging Reports</h1>
                  </div>
                  <Filters data={rows}>
                    <RadioButtonGroup name="status" valueSelected={this.state.filter} onChange={this.handleFilterChange.bind(this)}>
                      <RadioButton value="active" label="Acitve" />
                      <RadioButton value="inactive" label="Inactive"  defaultChecked={true} />
                      <RadioButton value="both" label="Both" />
                    </RadioButtonGroup>
                    <Checkbox  name="checkboxName1" value={this.state.showZeros} onCheck={this.handleshowZerosChange.bind(this)} label="Hide $0 Credit Balances" />
                    <DatePicker hintText="As of" mode="landscape" />
                  </Filters>
                  <Table
                    data={rowsData}
                    colNames={this.state.colNames}
                    colWidths={[4,1,1,1,1,1,1,2,2,2,2]}
                    maxWidth={18} />
                </div>
              </Layout>
            </Content>
          </Layout>
        </div>
        <Footer />
      </div>
    );
  }
};
